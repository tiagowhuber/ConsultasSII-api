name: SII Data Scheduler

on:
  schedule:
    # 35 runs per day, Mon-Sat, 7am-9pm Chilean time (UTC-3 summer)
    # 7am Chilean = 10:00 UTC | 9pm Chilean = 00:00 UTC (next day)
    # Runs approximately every 24-25 minutes
    
    # Morning runs (7am-9am Chilean)
    - cron: '0 10 * * 1-6'    # 7:00am
    - cron: '24 10 * * 1-6'   # 7:24am
    - cron: '48 10 * * 1-6'   # 7:48am
    
    # Mid-morning runs (9am-11am Chilean)
    - cron: '12 11 * * 1-6'   # 8:12am
    - cron: '36 11 * * 1-6'   # 8:36am
    - cron: '0 12 * * 1-6'    # 9:00am
    - cron: '24 12 * * 1-6'   # 9:24am
    - cron: '48 12 * * 1-6'   # 9:48am
    
    # Late morning runs (11am-1pm Chilean)
    - cron: '12 13 * * 1-6'   # 10:12am
    - cron: '36 13 * * 1-6'   # 10:36am
    - cron: '0 14 * * 1-6'    # 11:00am
    - cron: '24 14 * * 1-6'   # 11:24am
    - cron: '48 14 * * 1-6'   # 11:48am
    
    # Afternoon runs (1pm-3pm Chilean)
    - cron: '12 15 * * 1-6'   # 12:12pm
    - cron: '36 15 * * 1-6'   # 12:36pm
    - cron: '0 16 * * 1-6'    # 1:00pm
    - cron: '24 16 * * 1-6'   # 1:24pm
    - cron: '48 16 * * 1-6'   # 1:48pm
    
    # Mid-afternoon runs (3pm-5pm Chilean)
    - cron: '12 17 * * 1-6'   # 2:12pm
    - cron: '36 17 * * 1-6'   # 2:36pm
    - cron: '0 18 * * 1-6'    # 3:00pm
    - cron: '24 18 * * 1-6'   # 3:24pm
    - cron: '48 18 * * 1-6'   # 3:48pm
    
    # Late afternoon runs (5pm-7pm Chilean)
    - cron: '12 19 * * 1-6'   # 4:12pm
    - cron: '36 19 * * 1-6'   # 4:36pm
    - cron: '0 20 * * 1-6'    # 5:00pm
    - cron: '24 20 * * 1-6'   # 5:24pm
    - cron: '48 20 * * 1-6'   # 5:48pm
    
    # Evening runs (7pm-9pm Chilean)
    - cron: '12 21 * * 1-6'   # 6:12pm
    - cron: '36 21 * * 1-6'   # 6:36pm
    - cron: '0 22 * * 1-6'    # 7:00pm
    - cron: '24 22 * * 1-6'   # 7:24pm
    - cron: '48 22 * * 1-6'   # 7:48pm
    - cron: '12 23 * * 1-6'   # 8:12pm
    - cron: '36 23 * * 1-6'   # 8:36pm
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      year:
        description: 'Year (YYYY)'
        required: false
        default: ''
      month:
        description: 'Month (MM)'
        required: false
        default: ''

env:
  # Timezone for logging
  TZ: America/Santiago

jobs:
  fetch-sii-data:
    runs-on: ubuntu-latest
    # Only run if scheduler is enabled
    if: ${{ vars.ENABLE_SCHEDULER == 'true' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Set up timezone
        run: |
          sudo timedatectl set-timezone America/Santiago
          echo "Current time in Chile: $(date)"
      
      - name: Get current date
        id: date
        run: |
          # Use input values if provided (manual trigger), otherwise use current date
          if [ -n "${{ github.event.inputs.year }}" ] && [ -n "${{ github.event.inputs.month }}" ]; then
            echo "year=${{ github.event.inputs.year }}" >> $GITHUB_OUTPUT
            echo "month=${{ github.event.inputs.month }}" >> $GITHUB_OUTPUT
            echo "Manual trigger: ${{ github.event.inputs.year }}/${{ github.event.inputs.month }}"
          else
            echo "year=$(date +%Y)" >> $GITHUB_OUTPUT
            echo "month=$(date +%m)" >> $GITHUB_OUTPUT
            echo "Scheduled trigger: $(date +%Y)/$(date +%m)"
          fi
          
      - name: Check if valid day
        id: valid_day
        run: |
          # Get day of week (1=Monday, 7=Sunday)
          DAY_OF_WEEK=$(date +%u)
          if [ $DAY_OF_WEEK -le 6 ]; then
            echo "is_valid_day=true" >> $GITHUB_OUTPUT
            echo "✅ Running on day $DAY_OF_WEEK (Monday-Saturday)"
          else
            echo "is_valid_day=false" >> $GITHUB_OUTPUT
            echo "⏭️ Sunday (day $DAY_OF_WEEK), skipping"
          fi
      
      - name: Trigger SII Data Fetch
        if: steps.valid_day.outputs.is_valid_day == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "Starting SII data fetch for ${{ steps.date.outputs.year }}/${{ steps.date.outputs.month }}"
          
          # Test API availability first
          echo "Testing API health endpoint..."
          HEALTH_RESPONSE=$(curl -s "${{ secrets.API_BASE_URL }}/api/scheduler/health" -w "\nHTTP_STATUS:%{http_code}")
          HEALTH_STATUS=$(echo "$HEALTH_RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
          echo "Health check status: $HEALTH_STATUS"
          
          if [ "$HEALTH_STATUS" -ne 200 ]; then
            echo "API health check failed. API may not be properly deployed."
            echo "Health response: $HEALTH_RESPONSE"
            exit 1
          fi
          
          # Test SII test endpoint for debugging
          echo "Testing SII debug endpoint..."
          TEST_RESPONSE=$(curl -s "${{ secrets.API_BASE_URL }}/api/sii/test" -w "\nHTTP_STATUS:%{http_code}")
          TEST_STATUS=$(echo "$TEST_RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
          echo "Test endpoint status: $TEST_STATUS"
          TEST_BODY=$(echo "$TEST_RESPONSE" | sed '/HTTP_STATUS:/,$d')
          echo "Test response: $TEST_BODY"
          
          # Try the actual endpoint
          API_URL="${{ secrets.API_BASE_URL }}/api/sii/fetch-and-store/${{ steps.date.outputs.year }}/${{ steps.date.outputs.month }}"
          echo "API URL: $API_URL"
          
          echo "Making fetch-and-store request..."
          RESPONSE=$(curl -X POST \
            "$API_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SCHEDULER_SECRET }}" \
            -w "\nHTTP_STATUS:%{http_code}\nTIME_TOTAL:%{time_total}s\nREDIRECT_URL:%{redirect_url}" \
            -v \
            --max-time 600 \
            --connect-timeout 30 \
            --location-trusted \
            --fail-with-body)
          
          # Extract information
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
          TIME_TOTAL=$(echo "$RESPONSE" | grep "TIME_TOTAL:" | cut -d: -f2)
          REDIRECT_URL=$(echo "$RESPONSE" | grep "REDIRECT_URL:" | cut -d: -f2-)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/,$d')
          
          echo "Request completed in: $TIME_TOTAL"
          echo "HTTP Status: $HTTP_STATUS"
          echo "Redirect URL: $REDIRECT_URL"
          echo "Response: $RESPONSE_BODY"
          
          if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 201 ]; then
            echo "SII data fetch completed successfully!"
          else
            echo "SII data fetch failed with status: $HTTP_STATUS"
            exit 1
          fi
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "SII data fetch failed!"
          echo "Time: $(date)"
          echo "Target: ${{ steps.date.outputs.year }}/${{ steps.date.outputs.month }}"
          echo "Check the GitHub Actions logs for more details"