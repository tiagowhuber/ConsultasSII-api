name: SII Data Scheduler

on:
  schedule:
    # Schedule for Chilean timezone (UTC-3 in winter, UTC-4 in summer)
    # 8AM Chilean = 11AM UTC (winter) / 12PM UTC (summer) - using winter time
    - cron: '0 11 * * 1-5'
    # 11AM Chilean = 2PM UTC (winter) / 3PM UTC (summer)
    - cron: '0 14 * * 1-5'
    # 1PM Chilean = 4PM UTC (winter) / 5PM UTC (summer)
    - cron: '0 16 * * 1-5'
    # 4PM Chilean = 7PM UTC (winter) / 8PM UTC (summer)
    - cron: '0 19 * * 1-5'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      year:
        description: 'Year (YYYY)'
        required: false
        default: ''
      month:
        description: 'Month (MM)'
        required: false
        default: ''

env:
  # Timezone for logging
  TZ: America/Santiago

jobs:
  fetch-sii-data:
    runs-on: ubuntu-latest
    # Only run if scheduler is enabled
    if: ${{ vars.ENABLE_SCHEDULER == 'true' || github.event_name == 'workflow_dispatch' }}
    
    steps:
      - name: Set up timezone
        run: |
          sudo timedatectl set-timezone America/Santiago
          echo "Current time in Chile: $(date)"
      
      - name: Get current date
        id: date
        run: |
          # Use input values if provided (manual trigger), otherwise use current date
          if [ -n "${{ github.event.inputs.year }}" ] && [ -n "${{ github.event.inputs.month }}" ]; then
            echo "year=${{ github.event.inputs.year }}" >> $GITHUB_OUTPUT
            echo "month=${{ github.event.inputs.month }}" >> $GITHUB_OUTPUT
            echo "Manual trigger: ${{ github.event.inputs.year }}/${{ github.event.inputs.month }}"
          else
            echo "year=$(date +%Y)" >> $GITHUB_OUTPUT
            echo "month=$(date +%m)" >> $GITHUB_OUTPUT
            echo "Scheduled trigger: $(date +%Y)/$(date +%m)"
          fi
          
      - name: Check if business day
        id: business_day
        run: |
          # Get day of week (1=Monday, 7=Sunday)
          DAY_OF_WEEK=$(date +%u)
          if [ $DAY_OF_WEEK -le 5 ]; then
            echo "is_business_day=true" >> $GITHUB_OUTPUT
            echo "Today is a business day (day $DAY_OF_WEEK)"
          else
            echo "is_business_day=false" >> $GITHUB_OUTPUT
            echo "‚è≠Today is weekend (day $DAY_OF_WEEK), skipping"
          fi
      
      - name: Trigger SII Data Fetch
        if: steps.business_day.outputs.is_business_day == 'true' || github.event_name == 'workflow_dispatch'
        run: |
          echo "Starting SII data fetch for ${{ steps.date.outputs.year }}/${{ steps.date.outputs.month }}"
          
          # Test API availability first
          echo "Testing API health endpoint..."
          HEALTH_RESPONSE=$(curl -s "${{ secrets.API_BASE_URL }}/api/scheduler/health" -w "\nHTTP_STATUS:%{http_code}")
          HEALTH_STATUS=$(echo "$HEALTH_RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
          echo "Health check status: $HEALTH_STATUS"
          
          if [ "$HEALTH_STATUS" -ne 200 ]; then
            echo "API health check failed. API may not be properly deployed."
            echo "Health response: $HEALTH_RESPONSE"
            exit 1
          fi
          
          # Test SII test endpoint for debugging
          echo "Testing SII debug endpoint..."
          TEST_RESPONSE=$(curl -s "${{ secrets.API_BASE_URL }}/api/sii/test" -w "\nHTTP_STATUS:%{http_code}")
          TEST_STATUS=$(echo "$TEST_RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
          echo "Test endpoint status: $TEST_STATUS"
          TEST_BODY=$(echo "$TEST_RESPONSE" | sed '/HTTP_STATUS:/,$d')
          echo "Test response: $TEST_BODY"
          
          # Try the actual endpoint
          API_URL="${{ secrets.API_BASE_URL }}/api/sii/fetch-and-store/${{ steps.date.outputs.year }}/${{ steps.date.outputs.month }}"
          echo "API URL: $API_URL"
          
          echo "Making fetch-and-store request..."
          RESPONSE=$(curl -X POST \
            "$API_URL" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.SCHEDULER_SECRET }}" \
            -w "\nHTTP_STATUS:%{http_code}\nTIME_TOTAL:%{time_total}s\nREDIRECT_URL:%{redirect_url}" \
            -v \
            --max-time 600 \
            --connect-timeout 30 \
            --location-trusted \
            --fail-with-body)
          
          # Extract information
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS:" | cut -d: -f2)
          TIME_TOTAL=$(echo "$RESPONSE" | grep "TIME_TOTAL:" | cut -d: -f2)
          REDIRECT_URL=$(echo "$RESPONSE" | grep "REDIRECT_URL:" | cut -d: -f2-)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS:/,$d')
          
          echo "Request completed in: $TIME_TOTAL"
          echo "HTTP Status: $HTTP_STATUS"
          echo "Redirect URL: $REDIRECT_URL"
          echo "Response: $RESPONSE_BODY"
          
          if [ "$HTTP_STATUS" -eq 200 ] || [ "$HTTP_STATUS" -eq 201 ]; then
            echo "SII data fetch completed successfully!"
          else
            echo "SII data fetch failed with status: $HTTP_STATUS"
            exit 1
          fi
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "SII data fetch failed!"
          echo "Time: $(date)"
          echo "Target: ${{ steps.date.outputs.year }}/${{ steps.date.outputs.month }}"
          echo "Check the GitHub Actions logs for more details"